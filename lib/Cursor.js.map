{"version":3,"sources":["../src/Cursor.js"],"names":[],"mappings":"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","file":"Cursor.js","sourcesContent":["import AbstractCursor from 'liwi/lib/AbstractCursor';\n\nexport default class Cursor extends AbstractCursor {\n    constructor(cursor, store, query) {\n        super();\n        this._cursor = cursor;\n        this._store = store;\n        this._query = query;\n    }\n\n    get query() {\n        return this._query;\n    }\n\n    advance(count) {\n        this._cursor.skip(count);\n        return this;\n    }\n\n    next() {\n        return new Promise((resolve, reject) => {\n            this._cursor.nextObject((err, value) => {\n                if (err) {\n                    return reject(err);\n                }\n\n                this._result = value;\n                this.key = value && value._id;\n                resolve(this.key);\n            });\n        });\n    }\n\n    limit(newLimit) {\n        return new Promise((resolve, reject) => {\n            this._cursor.limit(newLimit, (err) => {\n                if (err) {\n                    return reject(err);\n                }\n\n                resolve();\n            });\n        });\n    }\n\n    count(applyLimit) {\n        return new Promise((resolve, reject) => {\n            this._cursor.count(applyLimit, (err, result) => {\n                if (err) {\n                    return reject(err);\n                }\n\n                resolve(result);\n            });\n        });\n    }\n\n    result() {\n        return Promise.resolve(this._result);\n    }\n\n    remove() {\n        return this._store.deleteByKey(this.key);\n    }\n\n    forEach(callback) {\n        return this.forEachResults((result) => {\n            return callback(this._store.toVO(result));\n        });\n    }\n\n    forEachResults(callback) {\n        return new Promise((resolve, reject) => {\n            var waitFor = 0;\n            this._cursor.each((err, result) => {\n                if (err) {\n                    return reject(err);\n                }\n\n                if (result === null) {\n                    // end !\n                    this.close();\n                    if (waitFor === 0) {\n                        resolve();\n                    }\n\n                    return;\n                }\n                try {\n                    var result = callback(result);\n                    if (result && typeof result.then === 'function') {\n                        waitFor++;\n                        result.then(() => {\n                            if (--waitFor === 0) {\n                                resolve();\n                            }\n                        }).catch(reject);\n                    }\n                } catch (err) {\n                    console.log(err.stack || err.message);\n                    reject(err);\n                }\n            });\n        });\n    }\n\n    toArray() {\n        return new Promise((resolve, reject) => {\n            this._cursor.toArray((err, results) => {\n                if (err) {\n                    return reject(err);\n                }\n                try {\n                    resolve(results.map((v => this._store.toVO(v))));\n                } catch(err) {\n                    reject(err);\n                }\n            });\n        });\n    }\n\n    close() {\n        if (this._cursor) {\n            this._cursor.close();\n            this._cursor = this._store = this._result = undefined;\n        }\n        return Promise.resolve();\n    }\n}\n\nCursor.prototype[Symbol.iterator] = function() {\n    return {\n        next: () => {\n            return {\n                done: this._cursor === undefined,\n                value: this.next().then((key) => {\n                    if (key === null) {\n                        this.close();\n                        return undefined;\n                    }\n                    return this.vo();\n                })\n            };\n        }\n    };\n};\n"]}